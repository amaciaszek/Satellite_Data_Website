---
title: "Satellite Data"
output: 
  rmarkdown::html_document:
    theme: darkly
---

```{r setup, include=FALSE}
library(ggplot2)
library(leaflet)
library(dplyr)
library(RColorBrewer)
library(IRdisplay)
library(ggimage)
library(tidyverse)
library(ggflags)
library(plotly)
library(countrycode)
library(tidytext)
library(scico)
library(tidyr)
library(readxl)
library(forcats) 
library(patchwork)
library(dplyr)
library(ggplot2)
library(ggflags)

# Read data from CSV and perform initial processing
all_space <- read.csv("nasaAPI.csv")
all_space$launchyear <- as.numeric(substr(all_space$LAUNCH, 1, 4))
all_space$launchmonth <- as.numeric(substr(all_space$LAUNCH, 6, 7))
all_space$launchday <- as.numeric(substr(all_space$LAUNCH, 9, 10))
all_space$launchyearmonth <- paste(substr(all_space$LAUNCH, 1, 7), "-01", sep = '')
all_space$LAUNCH <- as.Date(all_space$LAUNCH)
all_space$DECAY <- as.Date(all_space$DECAY)
all_space$launchyearmonth <- as.Date(all_space$launchyearmonth)

# Define helper function
timeorbit <- function(a, b) {
  b <- ifelse(is.na(b), Sys.Date(), b)
  as.numeric(difftime(b, a, units = "days"))
}

# Apply timeorbit function and filter payload objects
all_space$TimeOrbit <- mapply(timeorbit, all_space$LAUNCH, all_space$DECAY)
all_sat <- filter(all_space, OBJECT_TYPE == "PAYLOAD")

# Read Excel data and clean up
satellite_data <- read_excel("UCS-Satellite-Database 5-1-2023.xlsx")
all_na_columns <- colSums(is.na(satellite_data)) == nrow(satellite_data)
columns_to_keep <- !all_na_columns
cleaned_data <- satellite_data[, columns_to_keep]  # This step seems unused, consider removing
satellite_data$Comments <- paste(satellite_data$Comments, satellite_data$...29, sep = " ")
satellite_data <- satellite_data[, -which(names(satellite_data) == "...29")]

# Consolidate web source columns
web_source_columns <- grep("^Source|^\\.\\.\\.", names(satellite_data))
satellite_data$Web_Sources <- apply(satellite_data[, web_source_columns], 1, 
                                    function(x) paste(trimws(x, "both"), collapse = " "))
satellite_data <- satellite_data[, -web_source_columns]
satellite_data$Web_Sources <- gsub("\\bNA\\b", "", satellite_data$Web_Sources)
satellite_data$Web_Sources <- trimws(satellite_data$Web_Sources)
satellite_data$Web_Sources <- gsub("\\s+", " ", satellite_data$Web_Sources)

convert_excel_serial_date <- function(excel_serial_date) {
    # Convert to numeric, handling NA or non-numeric values
    numeric_date <- as.numeric(excel_serial_date)
    if (anyNA(numeric_date) || any(!is.numeric(numeric_date))) {
        if (anyNA(numeric_date)){standard_date <- NA}
        else{
        excel_serial_date <- gsub("//", "/", excel_serial_date)
        excel_serial_date <- strsplit(excel_serial_date,split = '/')
        excel_serial_date <- as.numeric(excel_serial_date[[1]])
        if (excel_serial_date[3]<50){
            excel_serial_date[3] <- excel_serial_date[3]+2000
        }
        excel_serial_date <- excel_serial_date[c(3, 1, 2)]
        standard_date <- paste(excel_serial_date, collapse = "-")}
    }
    standard_date <- as.Date("1899-12-30") + numeric_date - 1
    return(standard_date)
}

head(satellite_data$`Date of Launch`)
newlist <- c()
index <-2
for (date in satellite_data$`Date of Launch`) {
    convert_excel_serial_date(date)
    index <- index +1
}
satellite_data$`Date of Launch` <- convert_excel_serial_date(satellite_data$`Date of Launch`)
satellite_data$Launch_Year <- as.numeric(format(satellite_data$'Date of Launch', "%Y"))
satellite_data$Launch_Month <- as.numeric(format(satellite_data$'Date of Launch', "%m"))
satellite_data$Launch_Day <- as.numeric(format(satellite_data$'Date of Launch', "%d"))

                                 
head(satellite_data$Launch_Year)

# Merge the two datasets
merged_data <- merge(all_sat, satellite_data, by.x = "NORAD_CAT_ID", by.y = "NORAD Number", all = TRUE)
write.csv(merged_data, "merged_data0.csv", row.names = FALSE)

launches <- read.csv("launches.csv")

# Initialize columns for Year, Month, and Day
launches$Year <- NA
launches$Month <- NA
launches$Day <- NA

# Loop through the 'Net' column to extract date components
for (i in seq_along(launches$Net)) {
    date_parts <- strsplit(launches$Net[i], " ")[[1]][1]
    date_components <- as.numeric(strsplit(date_parts, '/')[[1]])
    
    # Assign the extracted components to the respective columns
    if (length(date_components) == 3) {
        launches$Year[i] <- date_components[3]
        launches$Month[i] <- date_components[1]
        launches$Day[i] <- date_components[2]
    }
}

# Filter out rows where Status is not 'TBA'
launches <- subset(launches, Status != "TBA")
                                    
merged_data <- merge(merged_data, launches, by.x = c("launchyear", "launchmonth", "launchday"), by.y = c("Year", "Month", "Day"), all.x = TRUE)
```

## Data Visualizations {.tabset}

### Number of Payloads Launched into Orbit by Year (1957-2023)
```{r, echo=FALSE}
merged_data$launchyear <- suppressWarnings(as.numeric(merged_data$launchyear))

# Filter data to exclude years >= 2024 and remove non-numeric/missing launch years
filtered_data <- merged_data[!is.na(merged_data$launchyear) & merged_data$launchyear < 2024, ]

# Define colors using RColorBrewer
colors <- brewer.pal(5, "Blues")[c(3, 4)]  # Selecting shades of blue

# Create ggplot object
p <- ggplot(filtered_data, aes(x = launchyear)) +
  geom_histogram(binwidth = 1, fill = colors[1], color = colors[2]) +
  labs(
    x = "Year Launched",
    y = "Number of Payloads per Year",
    caption = "\nCounts include both deorbited and in-orbit payloads, mostly satellites\nThis data was collected through www.space-track.org API"
  ) +
  scale_x_continuous(breaks = seq(1955, 2025, by = 5), expand = c(0, 0)) +
  scale_fill_brewer(type = "seq", palette = "Blues") +
  scale_y_continuous(breaks = seq(0, 3600, by = 400)) +
  theme_dark() +  # Set dark theme
  theme(
    plot.background = element_rect(fill = "black"),  # Change background to black
    text = element_text(color = "white"),  # Change text color to white
    axis.line = element_line(color = "white"),  # Set axis line color to white
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.title.y = element_text(margin = margin(r = 10)),
    axis.title.x = element_text(margin = margin(t = 10)),
    plot.title = element_blank(),  # Remove plot title
    plot.margin = unit(c(1, 1, 0, 1), "lines")  # Adjust plot margins as needed
  )

# Convert ggplot object to plotly
ggplotly(p)
```

**Description:**
This dataset encompasses counts of both deorbited and in-orbit payloads, predominantly satellites, including parts and supplies for all space stations. The data, sourced from the www.space-track.org API, spans the years 1957 to 2023.

### Top 10 Countries by Most Payloads Launched into Orbit
```{r, echo=FALSE}
payload_counts <- filtered_data %>% 
  group_by(COUNTRY) %>% 
  summarise(Count = n()) %>%
  ungroup() %>%
  mutate(COUNTRY = case_when(
    COUNTRY == "CIS" ~ "RU",
    COUNTRY == "PRC" ~ "CN",
    COUNTRY == "GER" ~ "DE",
    COUNTRY == "CAN" ~ "CA",
    COUNTRY == "FRA" ~ "FR",
    COUNTRY == "US" ~ "US",
    COUNTRY == "JPN" ~ "JP",
    COUNTRY == "IND" ~ "IN",
    COUNTRY == "UK" ~ "GB",
    COUNTRY == "ESA" ~ "EU",
    TRUE ~ COUNTRY
  ))

# Select the top 10 countries by payload count
top_10_payloads <- payload_counts %>%
  arrange(desc(Count)) %>%
  slice(1:10)

# Reorder factor levels based on payload count
top_10_payloads$COUNTRY <- factor(top_10_payloads$COUNTRY, levels = rev(top_10_payloads$COUNTRY))

# Calculate the maximum count for adjusting flag positions
max_count <- max(top_10_payloads$Count)

# Create ggplot2 bar chart with flags
p <- top_10_payloads %>%
  mutate(code = tolower(COUNTRY)) %>%
  ggplot(aes(x = COUNTRY, y = Count)) +
  geom_col(fill = "#7EB5D6", color = "black") +  # Change bar fill to light blue and outline color to black
  geom_flag(aes(y = Count + max_count * 0.2, country = code), size = 10) +  # Adjust the y-coordinate of flags
  geom_text(aes(label = Count, y = Count + max_count * 0.05), vjust = 0.5, size = 3.5, color = "white") +  # Position text labels above bars but below flags
  scale_y_continuous(expand = expansion(mult = c(0, 0.3)), breaks = seq(0, 12000, by = 2000)) +  # Set breaks on y-axis and expand limits
  scale_x_discrete(labels = c("RU" = "Russia", "CN" = "China", "US" = "United States", "DE" = "Germany", "CA" = "Canada", "FR" = "France", "JP" = "Japan", "IN" = "India", "GB" = "United Kingdom", "EU" = "European Space Agency")) +
  theme_minimal(base_size = 12) +  # Use a minimal theme for a cleaner look
  theme(
    plot.background = element_rect(fill = "black"),  # Change background to black
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, color = "white"),  # Rotate x-axis labels for readability and set text color to white
    axis.text.y = element_text(color = "white"),  # Set y-axis text color to white
    axis.title = element_text(color = "white"),  # Set axis title color to white
    panel.grid.major.x = element_blank(),  # Remove vertical gridlines
    panel.grid.major.y = element_line(color = "gray"),  # Add horizontal gridlines
    panel.grid.minor = element_blank(),  # Remove minor gridlines
    plot.margin = margin(5.5, 5.5, 5.5, 5.5),  # Adjust plot margins as needed (top, right, bottom, left)
    plot.title = element_blank()  # Remove plot title
  ) +
  labs(x = "Country of Origin", y = "Total Payload Count")

# Display the plot
print(p)
```

**Description:**
This dataset encompasses counts of both deorbited and in-orbit payloads, predominantly satellites, including parts and supplies for all space stations. Notably, USSR data points are not differentiated from Russian. The data, sourced from the www.space-track.org API, spans the years 1957 to 2023.

### Satellite Purposes by Year (2010-2022)
```{r, echo=FALSE}
# Processing data for satellite purposes
all_purposes <- na.omit(unique(c(merged_data$Purpose, merged_data$`Detailed Purpose`)))

process_purpose <- function(purpose) {
  if (grepl("/", purpose)) {
    split_strings <- unlist(strsplit(purpose, "/"))
    split_strings <- sapply(split_strings, function(x) ifelse(grepl(",", x), x, x))
    return(split_strings)
  } else {
    return(purpose)
  }
}

intermediate_strings <- unlist(lapply(all_purposes, process_purpose))
final_strings <- unique(intermediate_strings)

for (string in final_strings) {
  valid_column_name <- gsub("[^[:alnum:] ]", "", string)
  valid_column_name <- gsub(" ", "_", valid_column_name)
  merged_data[[valid_column_name]] <- FALSE
}

cleaned_data <- subset(merged_data, !is.na(Purpose))
all_combined_lists <- list()

for (x in 1:nrow(cleaned_data)) {
  y_purpose <- as.character(cleaned_data[x, 'Purpose'])
  y_detailed_purpose <- as.character(cleaned_data[x, 'Detailed Purpose'])

  split_list1 <- if (!is.na(y_purpose)) na.omit(strsplit(y_purpose, split = "/")[[1]]) else character(0)
  split_list2 <- if (!is.na(y_detailed_purpose)) na.omit(strsplit(y_detailed_purpose, split = "/")[[1]]) else character(0)
  combined_list <- c(split_list1, split_list2)

  all_combined_lists[[x]] <- combined_list
  for (z in combined_list) {
    cleaned_data[x, z] <- TRUE
  }
}

cleaned_data <- cleaned_data %>%
  mutate(`Automatic Identification System (AIS)` = if_else(`Meteorology, Automatic Identification System (AIS)`, TRUE, `Automatic Identification System (AIS)`),
         Meteorology = if_else(`Meteorology, Automatic Identification System (AIS)`, TRUE, Meteorology)) %>%
  select(-`Meteorology, Automatic Identification System (AIS)`)

# Additional column name adjustments
cleaned_data$AIS <- cleaned_data$`Automatic Identification System (AIS)`
cleaned_data$Intelligence <- cleaned_data$`Electronic Intelligence`
cleaned_data <- cleaned_data %>%
  mutate(`Optical Imaging` = `Optical` | `Optical Imaging`,
         `Optical Imaging` = `Optical Stereo Imaging` | `Optical Imaging`,
         `Optical Imaging` = `Optical Imaging (video)` | `Optical Imaging`,
         `Optical Imaging` = `Video Imaging` | `Optical Imaging`,
         Radar = `Radar Surveillance` | Radar,
         Radar = `Synthetic Aperture Radar (SAR)` | Radar,
         Radar = `Radar Imaging (SAR)` | Radar,
         Radar = `Radar Imaging` | Radar,
         `Radio Frequency Monitoring` = `Radio Spectrum Monitoring` | `Radio Frequency Monitoring`,
         Meteorology = `Meteorological` | Meteorology,
         Meteorology = `Meterology` | Meteorology,
         `Earth Science` = `Earth` | `Earth Science`) %>%
  select(-c(`Automatic Identification System (AIS)`, `Electronic Intelligence`, `Optical`, `Optical Stereo Imaging`,
            `Optical Imaging (video)`, `Video Imaging`, `Radar Surveillance`, `Synthetic Aperture Radar (SAR)`,
            `Radar Imaging (SAR)`, `Radar Imaging`, `Radio Spectrum Monitoring`, `Meteorological`, `Meterology`,
            `Earth`))

cleaned_data <- cleaned_data %>%
  mutate(across(61:length(names(cleaned_data)), ~ as.logical(.)))

# Pivot data for visualization
relevant_data <- cleaned_data %>%
  select(Launch_Year, 61:length(names(cleaned_data))) %>%
  pivot_longer(-Launch_Year, names_to = "Category", values_to = "Value") %>%
  filter(Value == TRUE) %>%
  group_by(Launch_Year, Category) %>%
  summarise(Count = n(), .groups = 'drop')

top_categories <- relevant_data %>%
  group_by(Category) %>%
  summarise(TotalCount = sum(Count)) %>%
  top_n(12, TotalCount) %>%
  pull(Category)

filtered_data <- relevant_data %>%
  filter(as.numeric(Launch_Year) >= 2010, as.numeric(Launch_Year) <= 2022) %>%
  mutate(Category = if_else(Category %in% top_categories, Category, 'Other')) %>%
  group_by(Category) %>%
  mutate(TotalCount = sum(Count)) %>%
  ungroup() %>%
  mutate(Category = reorder(Category, TotalCount),
         Category = fct_rev(Category)) %>%
  select(-TotalCount)

# New color palette
color_palette <- c(
  "AIS" = "#2E8B57",               
  "Communications" = "#FF4500",    
  "Earth Observation" = "#1E90FF",  
  "Earth Science" = "#8A2BE2",      
  "Intelligence" = "#32CD32",    
  "Global Positioning" = "#FFD700",  
  "Meteorology" = "#FF69B4",       
  "Navigation" = "#8B4513",       
  "Optical Imaging" = "#E5C494",   
  "Radar" = "#FF6347",          
  "Other" = "#708090",              
  "Space Science" = "#00BFFF",        
  "Technology Development" = "#FFFD43"
)

year_range <- range(filtered_data$Launch_Year)
year_breaks <- seq(from = year_range[1], to = year_range[2], by = 2)

filtered_data <- filtered_data %>%
  mutate(Facet = ifelse(Category == "Communications", "Communications", "Others"))

plot <- ggplot(filtered_data, aes(x = Launch_Year, y = Count, fill = Category, 
                                  text = paste("Year:", Launch_Year, "<br>Count:", Count, "<br>Category:", Category))) +
  geom_bar(stat = "identity", width = 0.7) +
  scale_fill_manual(values = color_palette) +
  facet_wrap(~ Facet, scales = "free_y", ncol = 1) +
  theme(
    plot.background = element_rect(fill = "black", color = NA),
    panel.background = element_rect(fill = "black", color = NA),
    text = element_text(color = "white"),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    legend.background = element_rect(fill = "black", color = NA),
    legend.key = element_rect(fill = "black", color = NA),
    axis.text = element_text(color = "white"),
    axis.title = element_text(color = "white"),
    strip.background = element_rect(fill = "black", color = NA),
    strip.text = element_text(color = "white"),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(x = "Launch Year", y = "Number of Satellites", fill = "Category") +
  ylim(-60, NA)

# Convert ggplot to plotly
plotly_plot <- ggplotly(plot, tooltip = "text") %>%
  layout(paper_bgcolor='black', plot_bgcolor='black')

# Save the plotly plot
plotly_plot
```

**Description:**
Each bar represents the number of satellites launched in a given year, categorized by their purposes. Some satellites serve multiple functions and are counted accordingly. The data is sourced from the www.space-track.org API.

### Total Rocket Launch Counts by Location (1957-2024)
```{r, echo=FALSE}
launches <- read.csv("launches.csv")
times <- numeric()
for (x in launches$Net){
    split_string <- strsplit(x, " ")
    split_string <- strsplit(split_string[[1]][1],'/')
    split_string <- as.numeric(split_string[[1]][3])
    times <- c(times, split_string)
}
launches$Year <- times
launches <- subset(launches, Status != "TBA")
#launches <- subset(launches, Status == "Launch Failure")

places <- c()
for (x in launches$Pad){
    split_string <- strsplit(x, "|", fixed = TRUE)[[1]]
    trimmed_string <- trimws(split_string)
    final_string <- gsub("\\s+", " ", trimmed_string)[2]
    places <- c(places, final_string)
}
launches$places <- places

uniqueplaces <- unique(launches$places)

latitudes <- c(45.965, 28.396837, NA, 34.751330, 37.883255, 48.5828, 
               33.677267, 30.778056, 62.925644, 31.2523, -2.938333, 
               28.573469, -30.955278, 5.239, 40.9547, 30.4, 13.7330, 
               28.240944, 38.8597, 31.884444, NA, 51.699997, -2.370497, 
               NA, 40.8570, 57.435833, 9.048167, 50.8, 35.258333, 
               34.431944, 39.660, 31.422927, 22.02278, 51.884318, 19.6164, 
               -39.261009, 30.400115, 32.990278, 25.9875, 36.200646, 
               -34.91, -12.390556, 37.096944, 33.099331)

# Longitudes
longitudes <- c(63.305, -80.605659, NA, -120.52023, -75.439339, 46.1141, 
                -106.475417, 3.053889, 40.577878, 131.0785, 40.2125, 
                -80.651070, 136.532222, -52.768, 100.2883, 130.97, 80.2350, 
                102.022600, 111.5907, 34.680278, NA, 128.0, -44.391164, 
                NA, 129.6665, -152.337778, 167.743086, 59.516669, 53.954722, 
                127.535000, 124.705, -104.757152, -159.785, 128.334832, 110.9534, 
                177.865297, 130.974025, 106.969167, 97.186389, 55.333933, 
                135.65, 136.795167, 6.738611, 126.604620)

# Create a data frame with places and their coordinates
coordinates_df <- data.frame(Place = uniqueplaces, Latitude = latitudes, Longitude = longitudes)
names(launches)[names(launches) == "places"] <- "Place"
launches <- merge(launches, coordinates_df, by = "Place", all.x = TRUE)
launches <- launches[complete.cases(launches$Latitude), ]

launches_counts <- launches %>%
  group_by(Latitude, Longitude, Place) %>%
  summarise(count = n(),
            years_active = paste(range(Year), collapse = " - "),
            .groups = "drop")  # Drop the grouping

# Scaling factor setup
min_radius <- 5  # Minimum radius for circles
max_radius <- 20  # Maximum radius for circles

# Calculate maximum and minimum counts
max_count <- max(launches_counts$count)
min_count <- min(launches_counts$count)
range_count <- max_count - min_count

# Adjust the scaling factor to account for count range
scaling_factor <- (max_radius - min_radius) / range_count

# Define custom breaks for coloring and legend
custom_breaks <- c(1, 10, 50, 100, 300, Inf)  # Manually set breaks, Inf indicates '>300'

# Define color palette and labels for the legend
num_colors <- length(custom_breaks) - 1
color_palette <- c("blue", "green", "yellow", "orange", "red")[1:num_colors]
labels <- c("< 10", "< 50", "< 100", "< 300", "300+")

# Function to determine color based on count
get_color <- function(count) {
  findInterval(count, custom_breaks, all.inside = TRUE)
}

# Create map with scaled circle markers and dynamic coloring
map <- leaflet(launches_counts) %>%
  addTiles() %>%
  addCircleMarkers(
    lat = ~Latitude,
    lng = ~Longitude,
    radius = ~min_radius + (count - min_count) * scaling_factor, # Updated radius calculation
    fillOpacity = 0.7,
    color = ~color_palette[get_color(count)],
    stroke = FALSE,
    popup = ~paste("Place:", Place, 
                   "<br>Total Launches:", count,
                   "<br>Years Active:", years_active)
  ) %>%
  addLegend(
    position = "bottomright",
    title = "Launch Count",
    labels = labels,
    colors = color_palette,
    opacity = 0.7
  )

map
```

**Description:**
This map displays all launch sites for rockets dating back to 1957, encompassing launches from both governmental and private entities, including unsuccessful ones. The color and size of each point correspond to the number of launches, with the option to access detailed information about each site, including location, exact launch count, and years of activity. This data is sourced from the Space Launch Now Database (https://spacelaunchnow.me/launch/).